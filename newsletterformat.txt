/**
 * Ofastshop Footer with Newsletter Functionality
 * Shortcode: [ofastshop_footer]
 */

// Create Newsletter Database Table on Activation
function ofastshop_create_newsletter_table() {
    global $wpdb;
    $table_name = $wpdb->prefix . 'ofastshop_newsletter';
    $charset_collate = $wpdb->get_charset_collate();

    $sql = "CREATE TABLE IF NOT EXISTS $table_name (
        id mediumint(9) NOT NULL AUTO_INCREMENT,
        name varchar(100) NOT NULL,
        email varchar(100) NOT NULL,
        ip_address varchar(100) DEFAULT '' NOT NULL,
        date_submitted datetime DEFAULT CURRENT_TIMESTAMP NOT NULL,
        PRIMARY KEY  (id),
        UNIQUE KEY email (email)
    ) $charset_collate;";

    require_once(ABSPATH . 'wp-admin/includes/upgrade.php');
    dbDelta($sql);
}
register_activation_hook(__FILE__, 'ofastshop_create_newsletter_table');

// Run table creation on init (for functions.php usage)
add_action('init', 'ofastshop_create_newsletter_table');

// Handle Newsletter Submission
function ofastshop_handle_newsletter_submission() {
    if (isset($_POST['ofastshop_newsletter_submit'])) {
        
        // Verify nonce
        if (!isset($_POST['ofastshop_newsletter_nonce']) || 
            !wp_verify_nonce($_POST['ofastshop_newsletter_nonce'], 'ofastshop_newsletter_action')) {
            wp_die('Security check failed');
        }

        global $wpdb;
        $table_name = $wpdb->prefix . 'ofastshop_newsletter';
        
        $name = sanitize_text_field($_POST['subscriber_name']);
        $email = sanitize_email($_POST['subscriber_email']);
        $ip_address = $_SERVER['REMOTE_ADDR'];
        
        // Validate
        if (empty($name) || empty($email) || !is_email($email)) {
            wp_redirect(add_query_arg('newsletter', 'invalid', wp_get_referer()));
            exit;
        }
        
        // Check if email already exists
        $exists = $wpdb->get_var($wpdb->prepare(
            "SELECT COUNT(*) FROM $table_name WHERE email = %s", $email
        ));
        
        if ($exists) {
            wp_redirect(add_query_arg('newsletter', 'exists', wp_get_referer()));
            exit;
        }
        
        // Insert into database
        $inserted = $wpdb->insert(
            $table_name,
            array(
                'name' => $name,
                'email' => $email,
                'ip_address' => $ip_address,
                'date_submitted' => current_time('mysql')
            ),
            array('%s', '%s', '%s', '%s')
        );
        
        if ($inserted) {
            // Send email notification
            $to = 'support@ofastshop.com';
            $subject = 'ðŸŽ‰ New Newsletter Subscriber - Ofastshop Digitals';
            $message = "
                New Newsletter Subscription!
                
                Name: $name
                Email: $email
                Date: " . current_time('F j, Y g:i A') . "
                IP Address: $ip_address
                
                View all subscribers in WordPress Admin: Newsletter Subscribers
            ";
            
            $headers = array('Content-Type: text/html; charset=UTF-8');
            wp_mail($to, $subject, nl2br($message), $headers);
            
            wp_redirect(add_query_arg('newsletter', 'success', wp_get_referer()));
            exit;
        } else {
            wp_redirect(add_query_arg('newsletter', 'error', wp_get_referer()));
            exit;
        }
    }
}
add_action('admin_post_nopriv_ofastshop_newsletter', 'ofastshop_handle_newsletter_submission');
add_action('admin_post_ofastshop_newsletter', 'ofastshop_handle_newsletter_submission');

// Add Admin Menu
function ofastshop_newsletter_admin_menu() {
    add_menu_page(
        'Newsletter Subscribers',
        'Newsletter Subscribers',
        'manage_options',
        'ofastshop-newsletter',
        'ofastshop_newsletter_admin_page',
        'dashicons-email-alt',
        30
    );
}
add_action('admin_menu', 'ofastshop_newsletter_admin_menu');

// Admin Page Content
function ofastshop_newsletter_admin_page() {
    global $wpdb;
    $table_name = $wpdb->prefix . 'ofastshop_newsletter';
    
    // Handle CSV Export
    if (isset($_GET['action']) && $_GET['action'] == 'export') {
        $subscribers = $wpdb->get_results("SELECT * FROM $table_name ORDER BY date_submitted DESC");
        
        header('Content-Type: text/csv');
        header('Content-Disposition: attachment; filename="newsletter-subscribers-' . date('Y-m-d') . '.csv"');
        
        $output = fopen('php://output', 'w');
        fputcsv($output, array('ID', 'Name', 'Email', 'IP Address', 'Date Submitted'));
        
        foreach ($subscribers as $subscriber) {
            fputcsv($output, array(
                $subscriber->id,
                $subscriber->name,
                $subscriber->email,
                $subscriber->ip_address,
                $subscriber->date_submitted
            ));
        }
        
        fclose($output);
        exit;
    }
    
    // Handle Delete
    if (isset($_GET['action']) && $_GET['action'] == 'delete' && isset($_GET['id'])) {
        $wpdb->delete($table_name, array('id' => intval($_GET['id'])));
        echo '<div class="notice notice-success"><p>Subscriber deleted successfully!</p></div>';
    }
    
    // Get all subscribers
    $subscribers = $wpdb->get_results("SELECT * FROM $table_name ORDER BY date_submitted DESC");
    $total = count($subscribers);
    
    ?>
    <div class="wrap">
        <h1>Newsletter Subscribers <span class="count">(<?php echo $total; ?>)</span></h1>
        
        <p>
            <a href="?page=ofastshop-newsletter&action=export" class="button button-primary">
                ðŸ“¥ Export to CSV
            </a>
        </p>
        
        <table class="wp-list-table widefat fixed striped">
            <thead>
                <tr>
                    <th>ID</th>
                    <th>Name</th>
                    <th>Email</th>
                    <th>IP Address</th>
                    <th>Date Submitted</th>
                    <th>Actions</th>
                </tr>
            </thead>
            <tbody>
                <?php if ($subscribers): ?>
                    <?php foreach ($subscribers as $subscriber): ?>
                        <tr>
                            <td><?php echo $subscriber->id; ?></td>
                            <td><?php echo esc_html($subscriber->name); ?></td>
                            <td><?php echo esc_html($subscriber->email); ?></td>
                            <td><?php echo esc_html($subscriber->ip_address); ?></td>
                            <td><?php echo date('F j, Y g:i A', strtotime($subscriber->date_submitted)); ?></td>
                            <td>
                                <a href="?page=ofastshop-newsletter&action=delete&id=<?php echo $subscriber->id; ?>" 
                                   class="button button-small"
                                   onclick="return confirm('Are you sure you want to delete this subscriber?')">
                                    Delete
                                </a>
                            </td>
                        </tr>
                    <?php endforeach; ?>
                <?php else: ?>
                    <tr>
                        <td colspan="6" style="text-align:center;">No subscribers yet.</td>
                    </tr>
                <?php endif; ?>
            </tbody>
        </table>
    </div>
    <?php
}

